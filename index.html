<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EEG Convolution Interactive</title>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f6f8;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 { margin: 10px 0 5px 0; }
        p.subtitle { margin-bottom: 30px; color: #666; text-align: center; }

        /* --- MAIN LAYOUT (3 COLUMNS) --- */
        .main-stage {
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: flex-start; /* Align to top */
            width: 100%;
            max-width: 900px;
            gap: 10px;
        }

        /* Columns */
        .col-graphs {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px; /* Space between graphs */
            min-width: 200px;
        }

        .col-image {
            flex: 2; /* Wider than regular graph columns */
            display: flex;
            flex-direction: column;
            gap: 20px;
            min-width: 300px;
        }

        .col-center {
            flex: 0 0 250px; /* Fixed width for the wiring diagram */
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .col-header {
            text-align: center;
            font-weight: bold;
            font-size: 1.1rem;
            color: #444;
            height: 30px;
            flex-shrink: 0;
            margin-bottom: -10px;
        }

        /* Graph Containers */
        .plot-wrapper {
            height: 160px; /* Fixed height for alignment */
            background: #fff;
            border-radius: 8px;
            border: 1px solid #ddd;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            position: relative;
        }

        .label-badge {
            position: absolute;
            left: 5px;
            top: 5px;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: bold;
            z-index: 10;
            font-size: 0.8rem;
            background: rgba(255,255,255,0.9);
            border: 1px solid #ccc;
        }

        .image-box {
            background: #fff;
            border-radius: 8px;
            border: 1px solid #ddd;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            padding: 25px; /* Increased padding */
            display: flex;
            align-items: center;
            justify-content: center;
            height: 520px; /* Match total height of 3 graphs + gaps */
            box-sizing: border-box; /* Include padding in height calculation */
        }

        .image-box img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        /* --- SVG DIAGRAM --- */
        .network-container {
            width: 100%;
            /* Calculated Height: 
               3 graphs * 160px height 
               + 2 gaps * 20px 
               = 520px total height to align perfectly 
            */
            height: 520px; 
            position: relative;
            margin-top: 25px;
        }

        svg {
            width: 100%;
            height: 100%;
            overflow: visible;
        }

        /* SVG Interactions */
        .connection-path {
            fill: none;
            transition: stroke-width 0.2s, stroke-opacity 0.2s;
        }
        
        /* Invisible fat path for easier clicking */
        .click-path {
            fill: none;
            stroke: transparent;
            stroke-width: 25px;
            cursor: pointer;
        }
        .click-path:hover + .connection-path {
            stroke-width: 4px; /* Highlight effect */
            filter: drop-shadow(0 0 3px rgba(0,0,0,0.3));
        }

        .weight-text-bg { fill: white; opacity: 0.85; }
        .weight-text {
            font-size: 12px;
            font-weight: bold;
            text-anchor: middle;
            dominant-baseline: middle;
            pointer-events: none;
            user-select: none;
        }

        /* --- BUTTONS --- */
        .btn-row {
            margin-top: 5px;
            display: flex;
            gap: 10px;
            justify-content: center;
            width: 100%;
        }

        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.2s;
        }
        button:active { transform: scale(0.98); }
        button:hover { opacity: 0.9; }

        .btn-reset { background-color: #34495e; color: white; }
        .btn-zero { background-color: #e74c3c; color: white; }
        .btn-random { background-color: #f39c12; color: white; }

        /* --- BOTTOM SLIDERS (Fine Tuning) --- */
        .sliders-section {
            margin-top: 20px;
            width: 100%;
            max-width: 1000px;
        }
        .sliders-section h3 { display: none; }
        
        .sliders-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }
        .slider-column {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #eee;
        }
        .slider-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .slider-row label { font-size: 0.85rem; width: 60px; }
        .slider-row input { flex: 1; margin: 0 10px; cursor: pointer; }
        .val-disp { font-size: 0.8rem; font-family: monospace; width: 35px; text-align: right; }

        /* Colors */
        .c1-color { color: #e67e22; border-color: #e67e22; }
        .c2-color { color: #c0392b; border-color: #c0392b; }
        .c3-color { color: #27ae60; border-color: #27ae60; }

        @media (max-width: 1000px) {
            .main-stage { flex-direction: column; align-items: center; }
            .col-center { height: 400px; width: 100%; margin: 20px 0; }
            .network-container { height: 100%; }
        }
    </style>
</head>
<body>

    <h1>EEG Convolution Demo</h1>
    <p class="subtitle">
        Click the arrows to disconnect wires. Use sliders below for fine-tuning.
    </p>

    <!-- Main 3-Column Layout -->
    <div class="main-stage">
        
        <!-- IMAGE BOX -->
        <div class="col-image">
            <div class="col-header">Components (C)</div>
            <div class="image-box">
                <img src="img/Source.png" alt="Source">
            </div>
        </div>
        
        <!-- LEFT: SOURCES -->
        <div class="col-graphs">
            <div class="col-header">Source Waveforms</div>
            <div id="plot-c1" class="plot-wrapper"><div class="label-badge c1-color" style="border-width:2px">C1 (Visual)</div></div>
            <div id="plot-c2" class="plot-wrapper"><div class="label-badge c2-color" style="border-width:2px">C2 (Stimulus)</div></div>
            <div id="plot-c3" class="plot-wrapper"><div class="label-badge c3-color" style="border-width:2px">C3 (Attention)</div></div>
        </div>

        <!-- CENTER: WIRING DIAGRAM -->
        <div class="col-center">
            <div class="col-header">Weights (W)</div>
            <div class="network-container" id="network-diagram">
                <!-- SVG Injected Here -->
            </div>
            
            <div class="btn-row">
                <button class="btn-reset" onclick="setDefaults()">Default</button>
                <button class="btn-zero" onclick="disconnectAll()">Disconnect</button>
                <button class="btn-random" onclick="setRandom()">Random</button>
            </div>
        </div>

        <!-- RIGHT: OBSERVED -->
        <div class="col-graphs">
            <div class="col-header">Observed Waveforms</div>
            <div id="plot-e1" class="plot-wrapper"><div class="label-badge" style="color:#2980b9">E1</div></div>
            <div id="plot-e2" class="plot-wrapper"><div class="label-badge" style="color:#2980b9">E2</div></div>
            <div id="plot-e3" class="plot-wrapper"><div class="label-badge" style="color:#2980b9">E3</div></div>
        </div>

        <!-- IMAGE BOX -->
        <div class="col-image">
            <div class="col-header">Electrodes (E)</div>
            <div class="image-box">
                <img src="img/Observed.png" alt="Observed">
            </div>
        </div>

    </div>

    <!-- BOTTOM: SLIDERS -->
    <div class="sliders-section">
        <div class="sliders-grid" id="sliders-container">
            <!-- Sliders generated by JS -->
        </div>
    </div>

    <script>
        // --- 1. CONFIGURATION & DATA ---
        
        const time = Array.from({length: 101}, (_, i) => i * 5); // 0 to 500ms
        const gaussian = (t, peak, width, amp) => amp * Math.exp(-0.5 * Math.pow((t - peak) / width, 2));

        // Source Signals - Updated for substantial overlap and specific shapes
        // C1: Peak ~130ms, wide enough to touch C2
        // C2: Dip ~210ms, overlaps C1 tail and C3 start
        // C3: Peak ~340ms, broad
        const sources = {
            c1: time.map(t => gaussian(t, 100, 30, 0.8)),
            c2: time.map(t => gaussian(t, 160, 35, -1.3)), 
            c3: time.map(t => gaussian(t, 290, 60, 1.4))
        };

        // State: Weights [Row][Col] -> C[Row] to E[Col]
        let weights = [
            [{val: 1.0, on: true}, {val: 0.25, on: true}, {val: 0.5, on: true}],
            [{val: 0.5, on: true}, {val: 0.5, on: true}, {val: -0.5, on: true}],
            [{val: 1.0, on: true}, {val: 0.75, on: true}, {val: 0.5, on: true}]
        ];

        // --- 2. PLOTLY SETUP ---

        const layout = {
            margin: { t: 25, b: 25, l: 30, r: 10 },
            xaxis: { range: [0, 500], showgrid: false, zeroline: false },
            yaxis: { range: [-1.5, 1.5], showticklabels: false, showgrid: false, zeroline: true },
            showlegend: false,
            height: 160 // Matches CSS height
        };
        const config = { staticPlot: true, responsive: true };

        // Draw Sources
        Plotly.newPlot('plot-c1', [{x: time, y: sources.c1, line:{color: '#e67e22', width: 3}}], layout, config);
        Plotly.newPlot('plot-c2', [{x: time, y: sources.c2, line:{color: '#c0392b', width: 3}}], layout, config);
        Plotly.newPlot('plot-c3', [{x: time, y: sources.c3, line:{color: '#27ae60', width: 3}}], layout, config);

        // Draw Observed (Placeholders)
        const blueLine = {color: '#2980b9', width: 3};
        Plotly.newPlot('plot-e1', [{x: time, y: [], line: blueLine}], layout, config);
        Plotly.newPlot('plot-e2', [{x: time, y: [], line: blueLine}], layout, config);
        Plotly.newPlot('plot-e3', [{x: time, y: [], line: blueLine}], layout, config);

        // --- 3. MAIN UPDATE LOOP ---

        function updateAll() {
            updateCalculations();
            renderSVG();
            updateSlidersUI();
        }

        function updateCalculations() {
            // Arrays for Observed Data
            let e1 = new Array(time.length).fill(0);
            let e2 = new Array(time.length).fill(0);
            let e3 = new Array(time.length).fill(0);

            for(let t=0; t<time.length; t++) {
                // Get Source Values at time t
                const s1 = sources.c1[t];
                const s2 = sources.c2[t];
                const s3 = sources.c3[t];

                // Get Effective Weights (0 if turned off)
                const w11 = weights[0][0].on ? weights[0][0].val : 0;
                const w12 = weights[0][1].on ? weights[0][1].val : 0;
                const w13 = weights[0][2].on ? weights[0][2].val : 0;

                const w21 = weights[1][0].on ? weights[1][0].val : 0;
                const w22 = weights[1][1].on ? weights[1][1].val : 0;
                const w23 = weights[1][2].on ? weights[1][2].val : 0;

                const w31 = weights[2][0].on ? weights[2][0].val : 0;
                const w32 = weights[2][1].on ? weights[2][1].val : 0;
                const w33 = weights[2][2].on ? weights[2][2].val : 0;

                // Linear Summation
                e1[t] = (s1 * w11) + (s2 * w21) + (s3 * w31);
                e2[t] = (s1 * w12) + (s2 * w22) + (s3 * w32);
                e3[t] = (s1 * w13) + (s2 * w23) + (s3 * w33);
            }

            Plotly.react('plot-e1', [{x: time, y: e1, line: blueLine}], layout, config);
            Plotly.react('plot-e2', [{x: time, y: e2, line: blueLine}], layout, config);
            Plotly.react('plot-e3', [{x: time, y: e3, line: blueLine}], layout, config);
        }

        // --- 4. SVG DIAGRAM ---

        const svgNS = "http://www.w3.org/2000/svg";
        const svgContainer = document.getElementById('network-diagram');
        
        // Vertical positions matching the CSS Graph locations
        // Each graph is 160px high with 20px gap. 
        // Centers: 80, 260 (160+20+80), 440 (160+20+160+20+80)
        const yCenters = [80, 260, 440]; 
        const colors = ['#e67e22', '#c0392b', '#27ae60'];

        function renderSVG() {
            svgContainer.innerHTML = '';
            const width = svgContainer.clientWidth;
            const height = 520; // Fixed total height

            const svg = document.createElementNS(svgNS, "svg");
            svg.setAttribute("viewBox", `0 0 ${width} ${height}`);
            svg.setAttribute("preserveAspectRatio", "none");

            // Define Arrow Marker
            const defs = document.createElementNS(svgNS, "defs");
            const marker = document.createElementNS(svgNS, "marker");
            marker.setAttribute("id", "head");
            marker.setAttribute("markerWidth", "12");
            marker.setAttribute("markerHeight", "12");
            marker.setAttribute("refX", "12");
            marker.setAttribute("refY", "6");
            marker.setAttribute("orient", "auto");
            marker.setAttribute("markerUnits", "userSpaceOnUse");
            const poly = document.createElementNS(svgNS, "polygon");
            poly.setAttribute("points", "0 0, 12 6, 0 12");
            poly.setAttribute("fill", "#555");
            marker.appendChild(poly);
            defs.appendChild(marker);
            svg.appendChild(defs);

            // Create single floating tooltip group
            const tooltipGroup = document.createElementNS(svgNS, "g");
            tooltipGroup.setAttribute("style", "opacity: 0; pointer-events: none; transition: opacity 0.1s;");
            
            const tooltipRect = document.createElementNS(svgNS, "rect");
            tooltipRect.setAttribute("width", "40");
            tooltipRect.setAttribute("height", "24");
            tooltipRect.setAttribute("rx", "4");
            tooltipRect.setAttribute("fill", "rgba(255, 255, 255, 0.9)");
            tooltipRect.setAttribute("stroke", "#ccc");
            tooltipRect.setAttribute("stroke-width", "1");
            
            const tooltipText = document.createElementNS(svgNS, "text");
            tooltipText.setAttribute("x", "20");
            tooltipText.setAttribute("y", "17"); // centered vertically in 24px height
            tooltipText.setAttribute("text-anchor", "middle");
            tooltipText.setAttribute("font-size", "12px");
            tooltipText.setAttribute("font-weight", "bold");
            tooltipText.setAttribute("fill", "#333");

            tooltipGroup.appendChild(tooltipRect);
            tooltipGroup.appendChild(tooltipText);

            // Draw Wires
            for(let r=0; r<3; r++) { // Sources (Left)
                for(let c=0; c<3; c++) { // Observed (Right)
                    const w = weights[r][c];
                    
                    const y1 = yCenters[r];
                    const y2 = yCenters[c];
                    
                    // Bezier Curve Logic
                    const cp1x = width * 0.4;
                    const cp2x = width * 0.6;
                    
                    const d = `M 0 ${y1} C ${cp1x} ${y1}, ${cp2x} ${y2}, ${width-4} ${y2}`;

                    const g = document.createElementNS(svgNS, "g");

                    // 1. Invisible Fat Path (Click Target)
                    const clickPath = document.createElementNS(svgNS, "path");
                    clickPath.setAttribute("d", d);
                    clickPath.setAttribute("class", "click-path");
                    clickPath.onclick = () => toggleWeight(r, c);

                    // 2. Visible Wire
                    const path = document.createElementNS(svgNS, "path");
                    path.setAttribute("d", d);
                    path.setAttribute("class", "connection-path");
                    path.setAttribute("marker-end", "url(#head)");
                    
                    if(w.on) {
                        path.setAttribute("stroke", colors[r]);
                        // Thickness based on absolute value
                        const thick = Math.max(1, Math.abs(w.val) * 6);
                        path.setAttribute("stroke-width", thick);
                        
                        // Opacity check for zero value
                        if(w.val === 0) path.setAttribute("stroke-opacity", 0.2);
                        else path.setAttribute("stroke-opacity", 1);
                    } else {
                        // OFF State
                        path.setAttribute("stroke", "#ccc");
                        path.setAttribute("stroke-width", 2);
                        path.setAttribute("stroke-dasharray", "5,5");
                    }

                    // Hover Logic
                    clickPath.onmouseenter = () => {
                        tooltipGroup.style.opacity = 1;
                        tooltipText.textContent = w.val.toFixed(2);
                    };
                    clickPath.onmousemove = (e) => {
                        // Transform mouse coordinates to SVG space
                        const pt = svg.createSVGPoint();
                        pt.x = e.clientX;
                        pt.y = e.clientY;
                        const svgP = pt.matrixTransform(svg.getScreenCTM().inverse());
                        
                        // Move tooltip to mouse position (offset slightly)
                        tooltipGroup.setAttribute("transform", `translate(${svgP.x + 10}, ${svgP.y - 20})`);
                    };
                    clickPath.onmouseleave = () => {
                        tooltipGroup.style.opacity = 0;
                    };

                    g.appendChild(path);      // Wire
                    g.appendChild(clickPath); // Invisible Click Area
                    
                    svg.appendChild(g);
                }
            }
            
            // Add connector dots at terminals
            const dotGroup = document.createElementNS(svgNS, "g");
            for(let y of yCenters) {
                // Left Dot
                let c1 = document.createElementNS(svgNS, "circle");
                c1.setAttribute("cx", 0); c1.setAttribute("cy", y); c1.setAttribute("r", 4); c1.setAttribute("fill", "#666");
                dotGroup.appendChild(c1);
                // Right Dot
                let c2 = document.createElementNS(svgNS, "circle");
                c2.setAttribute("cx", width); c2.setAttribute("cy", y); c2.setAttribute("r", 4); c2.setAttribute("fill", "#2980b9");
                dotGroup.appendChild(c2);
            }
            svg.appendChild(dotGroup);

            // Append tooltip last so it is on top
            svg.appendChild(tooltipGroup);

            svgContainer.appendChild(svg);
        }

        // --- 5. SLIDER UI GENERATION ---

        function updateSlidersUI() {
            const container = document.getElementById('sliders-container');
            container.innerHTML = ''; // Clear

            const sourceLabels = ["C1", "C2", "C3"];
            const colors = ['#e67e22', '#c0392b', '#27ae60'];

            // Create 3 columns of sliders (one per source)
            for(let r=0; r<3; r++) {
                const colDiv = document.createElement('div');
                colDiv.className = 'slider-column';
                colDiv.style.borderTop = `4px solid ${colors[r]}`;
                
                const header = document.createElement('h4');
                header.textContent = `${sourceLabels[r]} Weights`;
                header.style.margin = "0 0 10px 0";
                colDiv.appendChild(header);

                for(let c=0; c<3; c++) {
                    const rowDiv = document.createElement('div');
                    rowDiv.className = 'slider-row';

                    const label = document.createElement('label');
                    label.textContent = `to E${c+1}:`;

                    const input = document.createElement('input');
                    input.type = 'range';
                    input.min = -1; 
                    input.max = 1; 
                    input.step = 0.05;
                    input.value = weights[r][c].val;
                    
                    // Handle input
                    input.oninput = (e) => {
                        weights[r][c].val = parseFloat(e.target.value);
                        // If user moves slider, auto-enable the path if it was off
                        if(!weights[r][c].on) weights[r][c].on = true;
                        updateAll();
                    };

                    const disp = document.createElement('span');
                    disp.className = 'val-disp';
                    disp.textContent = weights[r][c].val.toFixed(2);
                    
                    if(!weights[r][c].on) {
                        rowDiv.style.opacity = 0.5;
                    }

                    rowDiv.appendChild(label);
                    rowDiv.appendChild(input);
                    rowDiv.appendChild(disp);
                    colDiv.appendChild(rowDiv);
                }
                container.appendChild(colDiv);
            }
        }

        // --- 6. ACTIONS ---

        function toggleWeight(r, c) {
            weights[r][c].on = !weights[r][c].on;
            updateAll();
        }

        function setDefaults() {
            weights = [
                [{val: 1.0, on: true}, {val: 0.25, on: true}, {val: 0.5, on: true}],
                [{val: 0.5, on: true}, {val: 0.5, on: true}, {val: -0.5, on: true}],
                [{val: 1.0, on: true}, {val: 0.75, on: true}, {val: 0.5, on: true}]
            ];
            updateAll();
        }

        function disconnectAll() {
            weights.forEach(row => row.forEach(w => {
                // Keep val the same, but turn it off
                w.on = false;
            }));
            updateAll();
        }

        function setRandom() {
            weights.forEach(row => row.forEach(w => {
                // Random between -1.00 and 1.00
                w.val = Math.round((Math.random() * 2 - 1) * 20) / 20; 
                w.on = true;
            }));
            updateAll();
        }

        // --- INIT ---
        updateAll();

    </script>
</body>
</html>
